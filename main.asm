org 0x100

[map all game.map]

        Level_Width equ 11
        Level_Height equ 11

        Tile_Width equ 16
        Tile_Height equ 16

section code

start:
        mov bp, sp
        sub sp, 0xa
.a0 equ -0xa
.x equ 0
.y equ 2
        mov word [bp + .x], 0
        mov word [bp + .y], 0

        mov ax, 0x0013
        int 0x10

        call kb_init
.loop:
        call wait_for_retrace
        call copy_buffer
        call clear_screen

        call draw_tilemap

        cmp byte [sprites + sprite.dir], 0
        jnz .controlskip

        cmp byte [key_a], 0
        jz .askip
        cmp byte [sprites + sprite.x], 0
        jbe .askip
        mov byte [sprites + sprite.dir], Dir_Left
.askip: cmp byte [key_d], 0
        jz .dskip
        cmp byte [sprites + sprite.x], Level_Width - 1
        jge .dskip
        mov byte [sprites + sprite.dir], Dir_Right
.dskip: cmp byte [key_w], 0
        jz .wskip
        cmp byte [sprites + sprite.y], 0
        je .wskip
        mov byte [sprites + sprite.dir], Dir_Up
.wskip: cmp byte [key_s], 0
        jz .sskip
        cmp byte [sprites + sprite.y], Level_Height - 1
        jge .sskip
        mov byte [sprites + sprite.dir], Dir_Down

.sskip:
.controlskip:

        ; update sprite
        cmp byte [sprites + sprite.dir], Dir_None
        je .updateskip

        inc byte [sprites + sprite.t]
        cmp byte [sprites + sprite.t], Tile_Width
        jne .updateskip

        mov byte [sprites + sprite.t], 0
        movzx si, byte [sprites + sprite.dir]
        mov byte [sprites + sprite.dir], 0
        shl si, 1
        mov ax, [.lut + si]
        jmp ax
.lut:   dw .none, .left, .up, .right, .down
.left:  dec byte [sprites + sprite.x]
        jmp .none
.up:    dec byte [sprites + sprite.y]
        jmp .none
.right: inc byte [sprites + sprite.x]
        jmp .none
.down:  inc byte [sprites + sprite.y]
        jmp .none
.none:


.updateskip:
        mov word [bp + .a0], sprites
        call draw_sprite

        jmp .loop

%include "graphics.asm"
%include "keyboard.asm"

        sprite.sprite equ 0
        sprite.x equ 2
        sprite.y equ 3
        sprite.dir equ 4
        sprite.t equ 5
        sprite.size equ 6

        Dir_None equ 0
        Dir_Left equ 1
        Dir_Up equ 2
        Dir_Right equ 3
        Dir_Down equ 4

sprites:
        dw sprite_bomb
        db 0, 0                 ; x, y
        db 0, 0                 ; dir, t

tile_block:
        db 0                    ; passable
        db 0                    ; destructible
        db 19,19,19,19,19,19,19,19,19,19,19,19,19,19,19,19
        db 19,22,25,25,25,25,25,25,25,25,25,25,25,25,25,19
        db 19,22,23,23,23,23,23,23,23,23,23,23,23,23,25,19
        db 19,22,23,23,23,23,23,26,25,23,23,23,23,23,25,19
        db 19,22,23,23,23,23,26,25,23,23,23,23,23,23,25,19
        db 19,22,23,23,23,23,26,25,23,23,23,23,23,23,25,19
        db 19,22,23,23,23,23,26,25,23,23,23,23,23,23,25,19
        db 19,22,23,23,23,23,23,23,23,23,23,23,23,23,25,19
        db 19,22,23,23,23,26,25,23,23,23,23,26,25,23,25,19
        db 19,22,23,23,26,25,23,23,23,23,26,25,23,23,25,19
        db 19,22,23,23,26,25,23,23,23,23,26,25,23,23,25,19
        db 19,22,23,23,26,25,23,23,23,23,26,25,23,23,25,19
        db 19,22,23,23,23,23,23,23,23,23,23,23,23,23,25,19
        db 19,22,23,23,23,23,23,23,23,23,23,23,23,23,25,19
        db 19,22,22,22,22,22,22,22,22,22,22,22,22,22,22,19
        db 19,19,19,19,19,19,19,19,19,19,19,19,19,19,19,19

tile_brick:
        db 0, 1                   ; passable, destructible
        db 17,17,17,17,17,17,17,17,17,17,17,17,17,17,17,17
        db 17,22,22,22,19,22,22,22,22,22,22,19,22,22,22,17
        db 17,21,113,113,19,113,113,113,113,113,113,19,113,113,22,17
        db 17,21,113,113,19,113,113,113,113,113,113,19,113,113,22,17
        db 17,21,113,113,19,113,113,113,113,113,113,19,113,113,22,17
        db 17,19,19,19,19,19,19,19,19,19,19,19,19,19,19,17
        db 17,21,22,22,22,22,22,19,22,22,22,22,22,22,19,17
        db 17,21,113,113,113,113,22,19,113,113,113,113,113,22,19,17
        db 17,21,113,113,113,113,22,19,113,113,113,113,113,22,19,17
        db 17,21,113,113,113,113,22,19,113,113,113,113,113,22,19,17
        db 17,19,19,19,19,19,19,19,19,19,19,19,19,19,19,17
        db 17,21,22,22,19,22,22,22,22,22,22,19,22,22,22,17
        db 17,21,113,22,19,113,113,113,113,113,22,19,113,113,22,17
        db 17,21,113,22,19,113,113,113,113,113,22,19,113,113,22,17
        db 17,21,21,21,19,21,21,21,21,21,21,19,21,21,22,17
        db 17,17,17,17,17,17,17,17,17,17,17,17,17,17,17,17

tile_ground:
        db 1, 0                 ; passable, destructible
        db 255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255
        db 255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255
        db 255,255,185,255,255,255,185,255,255,255,185,255,255,255,185,255
        db 255,255,185,255,255,255,185,255,255,255,185,255,255,255,185,255
        db 255,255,185,255,255,255,185,255,255,255,185,255,255,255,185,255
        db 255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255
        db 255,255,255,255,185,255,255,255,185,255,255,255,185,255,255,255
        db 255,255,255,255,185,255,255,255,185,255,255,255,185,255,255,255
        db 255,255,255,255,185,255,255,255,185,255,255,255,185,255,255,255
        db 255,255,255,255,185,255,255,255,185,255,255,255,185,255,255,255
        db 255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255
        db 255,255,185,255,255,255,185,255,255,255,185,255,255,255,185,255
        db 255,255,185,255,255,255,185,255,255,255,185,255,255,255,185,255
        db 255,255,185,255,255,255,185,255,255,255,185,255,255,255,185,255
        db 255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255
        db 255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255

sprite_bomb:
        db 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
        db 0,0,0,0,0,0,0,0,0,44,44,0,0,0,0,0
        db 0,0,0,0,0,0,0,44,43,43,0,0,0,0,0,0
        db 0,0,0,0,0,0,0,41,43,41,0,0,0,0,0,0
        db 0,0,0,0,0,0,16,41,41,0,0,0,0,0,0,0
        db 0,0,0,0,0,16,22,185,22,16,0,0,0,0,0,0
        db 0,0,0,0,16,22,22,185,22,22,16,0,0,0,0,0
        db 0,0,0,16,22,22,22,22,22,22,22,16,0,0,0,0
        db 0,0,0,19,22,22,22,22,22,22,22,16,0,0,0,0
        db 0,0,0,19,22,22,22,22,22,22,22,16,0,0,0,0
        db 0,0,0,0,19,22,22,22,22,22,16,0,0,0,0,0
        db 0,0,0,0,0,19,22,22,22,19,0,0,0,0,0,0
        db 0,0,0,0,0,0,19,19,19,0,0,0,0,0,0,0
        db 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
        db 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
        db 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0

tiles:
        dw tile_ground, tile_block, tile_brick

tile_map:
        db 0, 2, 0, 2, 0, 2, 0, 2, 0, 2, 0
        db 2, 1, 2, 1, 2, 1, 2, 1, 2, 1, 2
        db 0, 2, 0, 2, 0, 2, 0, 2, 0, 2, 0
        db 2, 1, 2, 1, 2, 1, 2, 1, 2, 1, 2
        db 0, 2, 0, 2, 0, 2, 0, 2, 0, 2, 0
        db 2, 1, 2, 1, 2, 1, 2, 1, 2, 1, 2
        db 0, 2, 0, 2, 0, 2, 0, 2, 0, 2, 0
        db 2, 1, 2, 1, 2, 1, 2, 1, 2, 1, 2
        db 0, 2, 0, 2, 0, 2, 0, 2, 0, 2, 0
        db 2, 1, 2, 1, 2, 1, 2, 1, 2, 1, 2
        db 0, 2, 0, 2, 0, 2, 0, 2, 0, 2, 0
